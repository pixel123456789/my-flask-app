<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <nav>
            <div class="logo">LK</div>
            <div id="dateTime" class="nav-date-time"></div>
            <button id="hamburger-menu" class="hamburger-menu">&#9776;</button>
            <ul id="desktop-menu" class="menu">
                <li><a href="{{ url_for('home') }}">Home</a></li>
                {% if current_user.is_authenticated %}
                    <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li><a href="{{ url_for('home') }}#contact">Contact</a></li>
                    <li><a href="{{ url_for('logout') }}">Logout</a></li>
                {% else %}
                    <li><a href="{{ url_for('home') }}#contact">Contact</a></li>
                    <li><a href="{{ url_for('register') }}">Register</a></li>
                    <li><a href="{{ url_for('login') }}">Login</a></li>
                {% endif %}
            </ul>
            <div id="mobile-menu" class="mobile-menu">
                <button id="close-btn" class="close-btn">&times;</button>
                <ul class="menu">
                    <li><a href="{{ url_for('home') }}">Home</a></li>
                    <br>
                    {% if current_user.is_authenticated %}
                        <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                        <br>
                        <li><a href="{{ url_for('home') }}#contact">Contact</a></li>
                        <br>
                        <li><a href="{{ url_for('logout') }}">Logout</a></li>
                        <br>
                    {% else %}
                        <li><a href="{{ url_for('home') }}#contact">Contact</a></li>
                        <br>
                        <li><a href="{{ url_for('register') }}">Register</a></li>
                        <br>
                        <li><a href="{{ url_for('login') }}">Login</a></li>
                    {% endif %}
                </ul>
            </div>
        </nav>
    </header>

    <main>
        <section class="dashboard-container">
            <h2>Dashboard</h2>
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="flash-messages">
                        {% for category, message in messages %}
                            <div class="flash-{{ category }}">{{ message }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <!-- User Quote Request Form -->
            {% if current_user.id != 'admin' %}
            <div class="form-container">
                <h3>Request a Quote</h3>
                <button class="btn" onclick="openRequestModal()">Open Request Form</button>
            </div>
            {% endif %}
            {% if current_user.id == 'admin' %}
            <div class="form-container">
                <h3>View Contact Form Messages</h3>
                <a href="{{ url_for('admin_messages') }}"><button class="btn">Open Inbox</button></a>
            </div>
             {% endif %}

            <!-- Admin Quote Management Table -->
            {% if current_user.id == 'admin' %}
            <h3>Manage Quotes</h3>
            <div id="search-container">
                <form id="search-form" method="get" action="{{ url_for('dashboard') }}">
                    <input id="search-input" type="text" name="search_query" placeholder="Search by Order ID" class="form-control">
                    <button id="search-button" type="submit" class="btn">Search</button>
                    <button id="reset-button" type="button" class="btn" onclick="resetSearch()">Reset</button>
                </form>
            </div>
            <table class="quote-table admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Business Type</th>
                        <th>Requirements</th>
                        <th>Contact Info</th>
                        <th>Status</th>
                        <th>Quote Price</th>
                        <th>Actions</th>
                        <th>Updates</th>
                    </tr>
                </thead>
                <tbody>
                    {% for quote in quotes %}
                    <tr>
                        <td>{{ quote.id }}</td>
                        <td>{{ quote.user_id }}</td>
                        <td>{{ quote.business_type }}</td>
                        <td>{{ quote.requirements }}</td>
                        <td>{{ quote.contact_info }}</td>
                        <td>{{ quote.status }}</td>
                        <td>{{ quote.quote_price or 'N/A' }}</td>
                        <td>
                            <button class="btn" onclick="openModal('{{ quote.id }}')">Details</button>
                        </td>
                        <td>
                            <button class="btn" onclick="showUpdates('{{ quote.id }}')">Show Updates</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}

            <!-- User Quotes Table -->
            {% if current_user.id != 'admin' %}
            <h3>Your Quotes</h3>
            <table class="quote-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Business Type</th>
                        <th>Requirements</th>
                        <th>Contact Info</th>
                        <th>Status</th>
                        <th>Quote Price</th>
                        <th>Updates</th>
                    </tr>
                </thead>
                <tbody>
                    {% for quote in quotes %}
                    <tr>
                        <td>{{ quote.id }}</td>
                        <td>{{ quote.business_type }}</td>
                        <td>{{ quote.requirements }}</td>
                        <td>{{ quote.contact_info }}</td>
                        <td>{{ quote.status }}</td>
                        <td>{{ quote.quote_price or 'N/A' }}</td>
                        <td><button class="btn" onclick="showUpdates('{{ quote.id }}')">Show Updates</button></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </section>

        <!-- Modal for Quote Details -->
        <div id="quoteModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeQuoteModal()">&times;</span>
                <h3>Quote Details</h3>
                <form id="quoteForm" method="post" action="{{ url_for('dashboard') }}">
                    {{ response_form.hidden_tag() }}
                    <input type="hidden" id="quote_id" name="quote_id">
                    <div id="quoteDetails"></div>
                    <label for="status">Status:</label>
                    {{ response_form.status(class_="form-control", id="response_form_status") }}
                    <label for="quote_price">Quote Price:</label>
                    {{ response_form.quote_price(class_="form-control", id="response_form_quote_price") }}
                    <button type="submit" class="btn">Submit Response</button>
                </form>
            </div>
        </div>

        <!-- Modal for Quote Request Form -->
        <div id="requestModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeRequestModal()">&times;</span>
                <h3>Request a Quote</h3>
                <form method="post" action="{{ url_for('dashboard') }}" id="requestForm">
                    {{ request_form.hidden_tag() }}
                    <label for="business_type">Business Type:</label>
                    {{ request_form.business_type(class_="form-control") }}
                    <label for="requirements">Requirements:</label>
                    {{ request_form.requirements(class_="form-control") }}
                    <label for="contact_info">Contact Info:</label>
                    {{ request_form.contact_info(class_="form-control") }}
                    <button type="submit" class="btn">Request Quote</button>
                </form>
            </div>
        </div>

        <!-- Modal for Updates -->
        <div id="updatesModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeUpdatesModal()">&times;</span>
                <h3>Updates</h3>
                <div id="updatesList"></div>
                {% if current_user.id == 'admin' %}
                <form id="updateForm" method="post" action="{{ url_for('add_update') }}">
                    {{ update_form.hidden_tag() }}
                    <label for="update_content">Update Content:</label>
                    {{ update_form.update_content(class_="form-control") }}
                    <button type="submit" class="btn">Add Update</button>
                </form>
                {% endif %}
            </div>
        </div>
    </main>
    <footer>
        <p>&copy; 2024 Liam Kinnaird. All rights reserved.</p>
    </footer>
    <script src="{{ url_for('static', filename='scripts.js') }}"></script>
    <script>
        // Function to open the updates modal and fetch updates for a specific quote
        function showUpdates(quoteId) {
            fetch(`{{ url_for('get_updates') }}?quote_id=${quoteId}`)
                .then(response => response.json())
                .then(data => {
                    let updatesList = document.getElementById('updatesList');
                    updatesList.innerHTML = '';
                    data.forEach(update => {
                        let updateDiv = document.createElement('div');
                        updateDiv.className = 'update-item';
                        updateDiv.innerHTML = `<strong>${update.timestamp}:</strong> ${update.content}`;
                        updatesList.appendChild(updateDiv);
                    });
                    document.getElementById('updatesModal').style.display = 'block';
                })
                .catch(error => console.error('Error fetching updates:', error));
        }

        // Function to open the details modal and fetch details for a specific quote
        function openModal(quoteId) {
            fetch(`/quote_details/${quoteId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    let quoteDetails = document.getElementById('quoteDetails');
                    quoteDetails.innerHTML = `
                        <p><strong>ID:</strong> ${data.id}</p>
                        <p><strong>User ID:</strong> ${data.user_id}</p>
                        <p><strong>Business Type:</strong> ${data.business_type}</p>
                        <p><strong>Requirements:</strong> ${data.requirements}</p>
                        <p><strong>Contact Info:</strong> ${data.contact_info}</p>
                        <p><strong>Status:</strong> ${data.status}</p>
                        <p><strong>Quote Price:</strong> ${data.quote_price}</p>
                    `;
                    document.getElementById('quote_id').value = data.id;
                    document.getElementById('response_form_status').value = data.status;
                    document.getElementById('response_form_quote_price').value = data.quote_price || '';
                    document.getElementById('quoteModal').style.display = 'block';
                })
                .catch(error => console.error('Error fetching quote details:', error));
        }

        function openRequestModal() {
            document.getElementById('requestModal').style.display = 'block';
        }

        function closeQuoteModal() {
            document.getElementById('quoteModal').style.display = 'none';
        }

        function closeRequestModal() {
            document.getElementById('requestModal').style.display = 'none';
        }

        function closeUpdatesModal() {
            document.getElementById('updatesModal').style.display = 'none';
        }

        function resetSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-form').submit();
        }

        // Function to update the date and time display in the navbar
        function updateDateTime() {
            const now = new Date();
            const dateTimeString = now.toLocaleString('en-GB', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                second: 'numeric',
            });
            document.getElementById('dateTime').textContent = dateTimeString;
        }

        // Update the date and time display every second
        setInterval(updateDateTime, 1000);

        document.getElementById('hamburger-menu').addEventListener('click', function() {
            document.getElementById('mobile-menu').classList.toggle('active');
        });

        document.getElementById('close-btn').addEventListener('click', function() {
            document.getElementById('mobile-menu').classList.remove('active');
        });
        
        // Initial call to display the date and time immediately
        updateDateTime();
    </script>
</body>
</html>
